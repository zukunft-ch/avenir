{% import "macros/nav.html" as nav %}
{% import "macros/footer.html" as site_footer %}

<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <title>{% block title %}{{ page.title | default(value=section.title | default(value=config.title)) }}{% endblock %} — {% if lang == "fr" %}Le Futur{% elif lang == "it" %}Il Futuro{% else %}Die Zukunft{% endif %}</title>
  <meta name="description" content="{% block description %}{{ page.description | default(value=section.description | default(value=config.description)) }}{% endblock %}">
  <meta name="theme-color" content="#ffffff" id="meta-theme-color">
  <script>
  (function() {
    var t = localStorage.getItem('theme');
    var isDark = t === 'dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches);
    if (isDark) {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.getElementById('meta-theme-color').setAttribute('content', '#0d0d0d');
    }
  })();
  </script>

  {# Hreflang alternates #}
  {% if page %}
    <link rel="alternate" hreflang="de" href="{{ page.permalink | replace(from="/fr/", to="/") | replace(from="/it/", to="/") }}">
    {% for t in page.translations %}
      <link rel="alternate" hreflang="{{ t.lang }}" href="{{ t.permalink }}">
    {% endfor %}
    <link rel="alternate" hreflang="x-default" href="{{ page.permalink | replace(from="/fr/", to="/") | replace(from="/it/", to="/") }}">
    <link rel="canonical" href="{{ page.permalink }}">
  {% elif section %}
    <link rel="alternate" hreflang="de" href="{{ section.permalink | replace(from="/fr/", to="/") | replace(from="/it/", to="/") }}">
    {% for t in section.translations %}
      <link rel="alternate" hreflang="{{ t.lang }}" href="{{ t.permalink }}">
    {% endfor %}
    <link rel="alternate" hreflang="x-default" href="{{ section.permalink | replace(from="/fr/", to="/") | replace(from="/it/", to="/") }}">
    <link rel="canonical" href="{{ section.permalink }}">
  {% endif %}

  {# Open Graph #}
  <meta property="og:type" content="website">
  <meta property="og:title" content="{% block og_title %}{{ page.title | default(value=section.title | default(value=config.title)) }}{% endblock %}">
  <meta property="og:description" content="{{ page.description | default(value=section.description | default(value=config.description)) }}">
  <meta property="og:image" content="{{ get_url(path='favicon.svg') }}">
  <meta property="og:locale" content="{{ lang }}">
  <meta name="twitter:card" content="summary_large_image">

  {# Favicon #}
  <link rel="icon" href="{{ get_url(path='favicon.svg') }}" type="image/svg+xml">

  {# CSS #}
  <link rel="stylesheet" href="{{ get_url(path='main.css') }}">

  {# Feeds #}
  {% if lang == "de" %}
    <link rel="alternate" type="application/atom+xml" title="Die Zukunft — Feed" href="{{ get_url(path='atom.xml') }}">
  {% elif lang == "fr" %}
    <link rel="alternate" type="application/atom+xml" title="Le Futur — Feed" href="{{ get_url(path='fr/atom.xml') }}">
  {% elif lang == "it" %}
    <link rel="alternate" type="application/atom+xml" title="Il Futuro — Feed" href="{{ get_url(path='it/atom.xml') }}">
  {% endif %}

  {% block head_extra %}{% endblock %}
</head>
<body>
  {{ nav::skip_link(lang=lang) }}
  {{ nav::topnav(lang=lang) }}
  {{ nav::sparkle_button() }}
  {{ nav::command_overlay(lang=lang) }}

  <main id="main">
    {% block content %}{% endblock %}
  </main>

  {% block footer %}{{ site_footer::footer(lang=lang) }}{% endblock %}

  <script>
  (function() {
    var btn = document.getElementById('sparkle-btn');
    var overlay = document.getElementById('command-overlay');
    var backdrop = document.getElementById('overlay-backdrop');
    var searchInput = document.getElementById('command-search');
    var nav = document.getElementById('command-nav');
    var links = nav ? nav.querySelectorAll('.command-overlay__link') : [];

    function open() {
      overlay.classList.add('is-open');
      backdrop.classList.add('is-open');
      btn.classList.add('is-open');
      overlay.setAttribute('aria-hidden', 'false');
      btn.setAttribute('aria-expanded', 'true');
      setTimeout(function() { searchInput.focus(); }, 150);
    }

    function close() {
      overlay.classList.remove('is-open');
      backdrop.classList.remove('is-open');
      btn.classList.remove('is-open');
      overlay.setAttribute('aria-hidden', 'true');
      btn.setAttribute('aria-expanded', 'false');
      searchInput.value = '';
      filterLinks('');
    }

    function filterLinks(q) {
      q = q.toLowerCase().trim();
      links.forEach(function(link) {
        var match = !q || link.textContent.toLowerCase().includes(q);
        link.style.display = match ? '' : 'none';
      });
    }

    btn.addEventListener('click', function() {
      overlay.classList.contains('is-open') ? close() : open();
    });

    backdrop.addEventListener('click', close);

    // Close on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('is-open')) {
        close();
      }
    });

    // Clicking inside the overlay only closes if it's a nav link
    overlay.addEventListener('click', function(e) {
      var link = e.target.closest('.command-overlay__link');
      if (link) {
        close();
      }
    });

    // Prevent lang switcher and settings from closing overlay
    var settings = overlay.querySelector('.command-overlay__settings');
    if (settings) {
      settings.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }

    if (searchInput) {
      searchInput.addEventListener('input', function() {
        filterLinks(this.value);
      });
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          var visible = nav.querySelector('.command-overlay__link:not([style*="display: none"])');
          if (visible) window.location.href = visible.href;
        }
      });
    }

    // Theme switch
    var themeBtn = document.getElementById('theme-toggle');
    var metaTheme = document.getElementById('meta-theme-color');
    if (themeBtn) {
      if (document.documentElement.getAttribute('data-theme') === 'dark') {
        themeBtn.setAttribute('aria-checked', 'true');
      }
      themeBtn.addEventListener('click', function() {
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if (isDark) {
          document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
          themeBtn.setAttribute('aria-checked', 'false');
          if (metaTheme) metaTheme.setAttribute('content', '#ffffff');
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          themeBtn.setAttribute('aria-checked', 'true');
          if (metaTheme) metaTheme.setAttribute('content', '#0d0d0d');
        }
      });
    }
  })();
  </script>
</body>
</html>
