{% import "macros/nav.html" as nav %}
{% import "macros/footer.html" as site_footer %}
{% import "macros/jsonld.html" as jsonld %}

<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <title>{% block title %}{{ page.title | default(value=section.title | default(value=config.title)) }}{% endblock %} — {% if lang == "fr" %}Le Futur{% elif lang == "it" %}Il Futuro{% elif lang == "en" %}The Future{% else %}Die Zukunft{% endif %}</title>
  <meta name="description" content="{% block description %}{{ page.description | default(value=section.description | default(value=config.description)) }}{% endblock %}">
  <meta name="author" content="{% if lang == 'fr' %}Le Futur{% elif lang == 'it' %}Il Futuro{% elif lang == 'en' %}The Future{% else %}Die Zukunft{% endif %}">
  <meta name="theme-color" content="#ffffff" id="meta-theme-color">
  <script>
  (function() {
    var t = localStorage.getItem('theme');
    var isDark = t === 'dark';
    if (isDark) {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.getElementById('meta-theme-color').setAttribute('content', '#0d0d0d');
    }
  })();
  </script>

  {# Hreflang alternates #}
  {% if page %}
    <link rel="alternate" hreflang="de" href="{{ page.permalink | replace(from="/fr/", to="/") | replace(from="/it/", to="/") | replace(from="/en/", to="/") }}">
    {% for t in page.translations %}
      <link rel="alternate" hreflang="{{ t.lang }}" href="{{ t.permalink }}">
    {% endfor %}
    <link rel="alternate" hreflang="x-default" href="{{ page.permalink | replace(from="/fr/", to="/") | replace(from="/it/", to="/") | replace(from="/en/", to="/") }}">
    <link rel="canonical" href="{{ page.permalink }}">
  {% elif section %}
    <link rel="alternate" hreflang="de" href="{{ section.permalink | replace(from="/fr/", to="/") | replace(from="/it/", to="/") | replace(from="/en/", to="/") }}">
    {% for t in section.translations %}
      <link rel="alternate" hreflang="{{ t.lang }}" href="{{ t.permalink }}">
    {% endfor %}
    <link rel="alternate" hreflang="x-default" href="{{ section.permalink | replace(from="/fr/", to="/") | replace(from="/it/", to="/") | replace(from="/en/", to="/") }}">
    <link rel="canonical" href="{{ section.permalink }}">
  {% endif %}

  {# Open Graph #}
  <meta property="og:type" content="website">
  <meta property="og:title" content="{% block og_title %}{{ page.title | default(value=section.title | default(value=config.title)) }}{% endblock %}">
  <meta property="og:description" content="{{ page.description | default(value=section.description | default(value=config.description)) }}">
  <meta property="og:image" content="{{ get_url(path='og-' ~ lang ~ '.png') }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="{{ page.title | default(value=section.title | default(value=config.title)) }} — {% if lang == 'fr' %}Le Futur{% elif lang == 'it' %}Il Futuro{% elif lang == 'en' %}The Future{% else %}Die Zukunft{% endif %}">
  <meta property="og:locale" content="{% if lang == 'de' %}de_CH{% elif lang == 'fr' %}fr_CH{% elif lang == 'it' %}it_CH{% elif lang == 'en' %}en_GB{% else %}{{ lang }}{% endif %}">
  {% set all_locales = ["de_CH", "fr_CH", "it_CH", "en_GB"] %}
  {% set current_locale = "de_CH" %}{% if lang == "fr" %}{% set current_locale = "fr_CH" %}{% elif lang == "it" %}{% set current_locale = "it_CH" %}{% elif lang == "en" %}{% set current_locale = "en_GB" %}{% endif %}
  {% for loc in all_locales %}{% if loc != current_locale %}
  <meta property="og:locale:alternate" content="{{ loc }}">
  {% endif %}{% endfor %}
  <meta property="og:url" content="{% if page %}{{ page.permalink }}{% elif section %}{{ section.permalink }}{% else %}{{ config.base_url }}{% endif %}">
  <meta property="og:site_name" content="{% if lang == 'fr' %}Le Futur{% elif lang == 'it' %}Il Futuro{% elif lang == 'en' %}The Future{% else %}Die Zukunft{% endif %}">

  {# Twitter Card #}
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ page.title | default(value=section.title | default(value=config.title)) }}">
  <meta name="twitter:description" content="{{ page.description | default(value=section.description | default(value=config.description)) }}">
  <meta name="twitter:image" content="{{ get_url(path='og-' ~ lang ~ '.png') }}">

  {# Fonts — loaded via link tags for reliable cross-browser loading #}
  <link rel="preconnect" href="https://api.fontshare.com" crossorigin>
  <link rel="preconnect" href="https://cdn.fontshare.com" crossorigin>
  <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=switzer@1&f[]=clash-display@600,700&display=swap">

  {# Favicon #}
  <link rel="icon" href="{{ get_url(path='favicon.svg') }}" type="image/svg+xml">
  <link rel="icon" href="{{ get_url(path='favicon.ico') }}" sizes="32x32">
  <link rel="apple-touch-icon" href="{{ get_url(path='apple-touch-icon.png') }}">
  <link rel="manifest" href="{{ get_url(path='site.webmanifest') }}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  {# CSS #}
  <link rel="stylesheet" href="{{ get_url(path='main.css') }}">
  <noscript><style>.hero__subline,.reveal-up{opacity:1!important;transform:none!important;pointer-events:auto!important}</style></noscript>

  {# Feeds #}
  {% if lang == "de" %}
    <link rel="alternate" type="application/atom+xml" title="Die Zukunft — Feed" href="{{ get_url(path='atom.xml') }}">
  {% elif lang == "fr" %}
    <link rel="alternate" type="application/atom+xml" title="Le Futur — Feed" href="{{ get_url(path='fr/atom.xml') }}">
  {% elif lang == "it" %}
    <link rel="alternate" type="application/atom+xml" title="Il Futuro — Feed" href="{{ get_url(path='it/atom.xml') }}">
  {% elif lang == "en" %}
    <link rel="alternate" type="application/atom+xml" title="The Future — Feed" href="{{ get_url(path='en/atom.xml') }}">
  {% endif %}

  {# JSON-LD structured data #}
  {{ jsonld::organization() }}
  {{ jsonld::website(lang=lang) }}
  {{ jsonld::webpage(title=page.title | default(value=section.title | default(value=config.title)), description=page.description | default(value=section.description | default(value=config.description)), url=current_url | default(value=config.base_url), lang=lang) }}

  {% block head_extra %}{% endblock %}

  <script>
  // Shared Swiss cross mesh helper — Canvas 2D (no WebGL)
  window.SwissCross = (function() {
    function buildPositions(arm, thick) {
      arm = arm != null ? arm : 3;
      thick = thick != null ? thick : 1;
      var positions = [];
      var seen = {};
      function add(x, y, z) {
        var key = x + ',' + y + ',' + z;
        if (!seen[key]) { seen[key] = true; positions.push([x, y, z]); }
      }
      for (var x = -arm; x <= arm; x++)
        for (var y = -thick; y <= thick; y++)
          for (var z = -thick; z <= thick; z++) add(x, y, z);
      for (var x = -thick; x <= thick; x++)
        for (var y = -arm; y <= arm; y++)
          for (var z = -thick; z <= thick; z++) add(x, y, z);
      for (var x = -thick; x <= thick; x++)
        for (var y = -thick; y <= thick; y++)
          for (var z = -arm; z <= arm; z++) add(x, y, z);
      return positions;
    }

    var cubeEdges = [[0,1],[1,3],[3,2],[2,0],[4,5],[5,7],[7,6],[6,4],[0,4],[1,5],[2,6],[3,7]];
    var cubeVerts = [[-0.5,-0.5,-0.5],[0.5,-0.5,-0.5],[-0.5,0.5,-0.5],[0.5,0.5,-0.5],[-0.5,-0.5,0.5],[0.5,-0.5,0.5],[-0.5,0.5,0.5],[0.5,0.5,0.5]];

    function create(canvas, opts) {
      if (!canvas) return;
      opts = opts || {};
      var container = canvas.parentElement;
      var ctx = canvas.getContext('2d');
      if (!ctx) return;

      var w, h, dpr;
      var camZ = opts.cameraZ || 22;
      var cubeSize = opts.cubeSize || 0.88;
      var fovRad = (opts.fov || 35) * Math.PI / 180;
      var camX = opts.camX || 0;
      var camY = opts.camY || 0;

      var positions = buildPositions(opts.arm, opts.thick);

      var allEdges = [];
      for (var i = 0; i < positions.length; i++) {
        var p = positions[i];
        for (var e = 0; e < cubeEdges.length; e++) {
          var a = cubeVerts[cubeEdges[e][0]];
          var b = cubeVerts[cubeEdges[e][1]];
          allEdges.push([
            p[0] + a[0] * cubeSize, p[1] + a[1] * cubeSize, p[2] + a[2] * cubeSize,
            p[0] + b[0] * cubeSize, p[1] + b[1] * cubeSize, p[2] + b[2] * cubeSize
          ]);
        }
      }

      var rotX = 0.4, rotY = 0.6;

      function getColor() {
        var dark = document.documentElement.getAttribute('data-theme') === 'dark';
        return { color: dark ? '#7c3aed' : '#a855f7', opacity: opts.opacity || (dark ? 0.25 : 0.18) };
      }

      var style = getColor();

      function resize() {
        w = container.offsetWidth;
        h = container.offsetHeight;
        dpr = Math.min(window.devicePixelRatio || 1, w < 768 ? 1.5 : 2);
        canvas.width = w * dpr;
        canvas.height = h * dpr;
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
      }
      resize();

      function project(x, y, z) {
        var f = 1 / Math.tan(fovRad / 2);
        var px = x - camX;
        var py = y - camY;
        var pz = z - camZ;
        if (pz >= -0.1) return null;
        var sx = (f * px / -pz) * (h * dpr / 2) + (w * dpr / 2);
        var sy = (f * -py / -pz) * (h * dpr / 2) + (h * dpr / 2);
        return [sx, sy];
      }

      function rotatePoint(x, y, z) {
        var cosX = Math.cos(rotX), sinX = Math.sin(rotX);
        var y1 = y * cosX - z * sinX;
        var z1 = y * sinX + z * cosX;
        var cosY = Math.cos(rotY), sinY = Math.sin(rotY);
        var x2 = x * cosY + z1 * sinY;
        var z2 = -x * sinY + z1 * cosY;
        return [x2, y1, z2];
      }

      var raf;
      function draw() {
        raf = requestAnimationFrame(draw);
        rotY += 0.002;
        rotX += 0.0005;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = style.color;
        ctx.globalAlpha = style.opacity;
        ctx.lineWidth = dpr;
        ctx.beginPath();

        for (var i = 0; i < allEdges.length; i++) {
          var e = allEdges[i];
          var ra = rotatePoint(e[0], e[1], e[2]);
          var rb = rotatePoint(e[3], e[4], e[5]);
          var pa = project(ra[0], ra[1], ra[2]);
          var pb = project(rb[0], rb[1], rb[2]);
          if (!pa || !pb) continue;
          ctx.moveTo(pa[0], pa[1]);
          ctx.lineTo(pb[0], pb[1]);
        }

        ctx.stroke();
      }
      draw();

      window.addEventListener('resize', function() { resize(); });

      var observer = new MutationObserver(function() { style = getColor(); });
      observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

      var paused = false;
      var io = new IntersectionObserver(function(entries) {
        if (entries[0].isIntersecting) {
          if (paused) { paused = false; draw(); }
        } else {
          paused = true;
          cancelAnimationFrame(raf);
        }
      }, { threshold: 0 });
      io.observe(container);
    }

    return { create: create };
  })();
  </script>
</head>
<body>
  {{ nav::skip_link(lang=lang) }}
  {{ nav::topnav(lang=lang) }}
  {{ nav::sparkle_button(lang=lang) }}
  {{ nav::command_overlay(lang=lang) }}

  <div class="share-overlay" id="share-overlay" aria-hidden="true" role="dialog" aria-label="Share">
    <button class="share-overlay__close" id="share-close" type="button" aria-label="Close">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <div class="share-overlay__inner">
      <div class="share-overlay__meta">
        <span class="share-overlay__hex" id="share-hex">0x0000</span>
        <span class="share-overlay__breadcrumb" id="share-breadcrumb"></span>
        <h2 class="share-overlay__title" id="share-title"></h2>
      </div>
      <div class="share-overlay__url-row">
        <input class="share-overlay__url" id="share-url" readonly>
        <button class="share-overlay__copy" id="share-copy" type="button">Copy</button>
      </div>
      <nav class="share-overlay__links" aria-label="Share on">
        <a class="share-overlay__link" id="share-x" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>X</a>
        <a class="share-overlay__link" id="share-linkedin" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>LinkedIn</a>
        <a class="share-overlay__link" id="share-whatsapp" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>WhatsApp</a>
        <a class="share-overlay__link" id="share-telegram" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0 12 12 0 0011.944 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 01.171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>Telegram</a>
        <a class="share-overlay__link" id="share-email"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>Email</a>
      </nav>
    </div>
  </div>

  <nav class="progress-tracker" id="progress-tracker" aria-label="{{ trans(key='aria_reading_progress', lang=lang) }}"></nav>

  <button class="to-top" id="to-top" type="button" aria-label="{{ trans(key='aria_scroll_top', lang=lang) }}">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
  </button>

  <main id="main" data-hex-page="{% if page %}{{ page.relative_path | split(pat='.') | first }}{% elif section %}{{ section.relative_path | split(pat='.') | first }}{% endif %}">
    {% block content %}{% endblock %}
  </main>

  {% block footer %}{{ site_footer::footer(lang=lang) }}{% endblock %}

  <script>
  (function() {
    var btns = document.querySelectorAll('.sparkle-btn');
    var overlay = document.getElementById('command-overlay');
    var backdrop = document.getElementById('overlay-backdrop');
    var searchInput = document.getElementById('command-search');
    var nav = document.getElementById('command-nav');
    var topnav = document.querySelector('.topnav');
    var links = nav ? nav.querySelectorAll('.command-overlay__link') : [];

    function open() {
      /* Close share overlay if open */
      var shareOv = document.getElementById('share-overlay');
      if (shareOv && shareOv.classList.contains('is-open')) {
        shareOv.classList.remove('is-open');
        shareOv.setAttribute('aria-hidden', 'true');
      }
      overlay.classList.add('is-open');
      backdrop.classList.add('is-open');
      btns.forEach(function(b) { b.classList.add('is-open'); b.setAttribute('aria-expanded', 'true'); });
      overlay.setAttribute('aria-hidden', 'false');
      if (topnav) topnav.style.display = 'none';
      setTimeout(function() { searchInput.focus(); }, 150);
    }

    function close() {
      overlay.classList.remove('is-open');
      backdrop.classList.remove('is-open');
      btns.forEach(function(b) { b.classList.remove('is-open'); b.setAttribute('aria-expanded', 'false'); });
      overlay.setAttribute('aria-hidden', 'true');
      if (topnav) topnav.style.display = '';
      searchInput.value = '';
      filterLinks('');
      if (triggerBtn) { triggerBtn.focus(); triggerBtn = null; }
    }

    var liveRegion = document.getElementById('search-live');
    var searchResultOne = '{{ trans(key="search_result_one", lang=lang) }}';
    var searchResultMany = '{{ trans(key="search_result_many", lang=lang) }}';

    function filterLinks(q) {
      q = q.toLowerCase().trim();
      var count = 0;
      links.forEach(function(link) {
        var match = !q || link.textContent.toLowerCase().includes(q);
        link.style.display = match ? '' : 'none';
        if (match) count++;
      });
      if (liveRegion) {
        liveRegion.textContent = q ? (count + ' ' + (count === 1 ? searchResultOne : searchResultMany)) : '';
      }
    }

    var triggerBtn = null;

    btns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (overlay.classList.contains('is-open')) {
          close();
        } else {
          triggerBtn = btn;
          open();
        }
      });
    });

    backdrop.addEventListener('click', close);

    // Close on Escape + focus trap
    document.addEventListener('keydown', function(e) {
      if (!overlay.classList.contains('is-open')) return;
      if (e.key === 'Escape') {
        close();
        return;
      }
      // Focus trap: keep Tab within overlay
      if (e.key === 'Tab') {
        var focusable = overlay.querySelectorAll('a:not([style*="display: none"]), button, input, [tabindex]:not([tabindex="-1"])');
        if (!focusable.length) return;
        var first = focusable[0];
        var last = focusable[focusable.length - 1];
        if (e.shiftKey) {
          if (document.activeElement === first) { e.preventDefault(); last.focus(); }
        } else {
          if (document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      }
    });

    // Clicking inside the overlay only closes if it's a nav link
    overlay.addEventListener('click', function(e) {
      var link = e.target.closest('.command-overlay__link');
      if (link) {
        close();
      }
    });

    // Prevent lang switcher and settings from closing overlay
    var settings = overlay.querySelector('.command-overlay__settings');
    if (settings) {
      settings.addEventListener('click', function(e) {
        e.stopPropagation();
      });
    }

    if (searchInput) {
      searchInput.addEventListener('input', function() {
        filterLinks(this.value);
        updateScrollArrows();
      });
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          var visible = nav.querySelector('.command-overlay__link:not([style*="display: none"])');
          if (visible) window.location.href = visible.href;
        }
      });
    }

    // Nav scroll arrows
    var scrollUp = document.getElementById('nav-scroll-up');
    var scrollDown = document.getElementById('nav-scroll-down');

    function updateScrollArrows() {
      if (!nav) return;
      var atTop = nav.scrollTop <= 0;
      var atBottom = nav.scrollTop + nav.clientHeight >= nav.scrollHeight - 1;
      var canScroll = nav.scrollHeight > nav.clientHeight;
      if (scrollUp) scrollUp.classList.toggle('is-visible', canScroll && !atTop);
      if (scrollDown) scrollDown.classList.toggle('is-visible', canScroll && !atBottom);
    }

    if (nav) {
      nav.addEventListener('scroll', updateScrollArrows);
    }
    if (scrollUp) {
      scrollUp.addEventListener('click', function(e) {
        e.stopPropagation();
        nav.scrollBy({ top: -120, behavior: 'smooth' });
      });
    }
    if (scrollDown) {
      scrollDown.addEventListener('click', function(e) {
        e.stopPropagation();
        nav.scrollBy({ top: 120, behavior: 'smooth' });
      });
    }

    // Update arrows when overlay opens
    var origOpen = open;
    open = function() {
      origOpen();
      setTimeout(updateScrollArrows, 50);
    };

    // Theme switch
    var themeBtn = document.getElementById('theme-toggle');
    function setThemeColor(color) {
      var old = document.getElementById('meta-theme-color');
      if (old) old.remove();
      var m = document.createElement('meta');
      m.name = 'theme-color';
      m.id = 'meta-theme-color';
      m.content = color;
      document.head.appendChild(m);
    }
    if (themeBtn) {
      if (document.documentElement.getAttribute('data-theme') === 'dark') {
        themeBtn.setAttribute('aria-checked', 'true');
      }
      themeBtn.addEventListener('click', function() {
        var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if (isDark) {
          document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
          themeBtn.setAttribute('aria-checked', 'false');
          setThemeColor('#ffffff');
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          themeBtn.setAttribute('aria-checked', 'true');
          setThemeColor('#0d0d0d');
        }
      });
    }
  })();
  </script>

  <script>
  // Animated plasma — offscreen WebGL rendered into each .canvas section
  // 4 color presets cycle across sections for visual diversity
  (function() {
    var motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    if (motionQuery.matches) return;

    var sections = document.querySelectorAll('main > .canvas');
    if (!sections.length) return;

    var offscreen = document.createElement('canvas');
    var gl = offscreen.getContext('webgl', { powerPreference: 'low-power', preserveDrawingBuffer: true });
    if (!gl) return;

    var vsSource = 'attribute vec2 a_position; void main() { gl_Position = vec4(a_position, 0.0, 1.0); }';
    var fsSource = 'precision mediump float; uniform float u_time; uniform vec2 u_resolution; uniform vec3 u_color0; uniform vec3 u_color1; uniform vec3 u_color2; uniform float u_scale; uniform float u_lift; uniform float u_saturation; void main() { vec2 uv = gl_FragCoord.xy / u_resolution * 3.0; float t = u_time * 0.12; float v = 0.0; v += sin(uv.x * 1.1 + t); v += sin(uv.y * 1.3 - t * 0.7); v += sin((uv.x + uv.y) * 0.7 + t * 0.5); v += sin(length(uv - vec2(1.5)) * 1.4 - t * 0.6); v = v * 0.25 + 0.5; vec3 col; if (v < 0.33) { col = mix(u_color0, u_color1, v / 0.33); } else if (v < 0.66) { col = mix(u_color1, u_color2, (v - 0.33) / 0.33); } else { col = mix(u_color2, u_color0, (v - 0.66) / 0.34); } float grey = dot(col, vec3(0.299, 0.587, 0.114)); col = mix(vec3(grey), col, u_saturation); col = col * u_scale + vec3(u_lift); gl_FragColor = vec4(col, 1.0); }';

    function compileShader(src, type) {
      var s = gl.createShader(type);
      gl.shaderSource(s, src);
      gl.compileShader(s);
      if (!gl.getShaderParameter(s, gl.COMPILE_STATUS)) { gl.deleteShader(s); return null; }
      return s;
    }

    var vs = compileShader(vsSource, gl.VERTEX_SHADER);
    var fs = compileShader(fsSource, gl.FRAGMENT_SHADER);
    if (!vs || !fs) return;

    var program = gl.createProgram();
    gl.attachShader(program, vs);
    gl.attachShader(program, fs);
    gl.linkProgram(program);
    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) return;
    gl.useProgram(program);

    var buf = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, buf);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, 1,1]), gl.STATIC_DRAW);
    var aPos = gl.getAttribLocation(program, 'a_position');
    gl.enableVertexAttribArray(aPos);
    gl.vertexAttribPointer(aPos, 2, gl.FLOAT, false, 0, 0);

    var uTime = gl.getUniformLocation(program, 'u_time');
    var uRes = gl.getUniformLocation(program, 'u_resolution');
    var uColor0 = gl.getUniformLocation(program, 'u_color0');
    var uColor1 = gl.getUniformLocation(program, 'u_color1');
    var uColor2 = gl.getUniformLocation(program, 'u_color2');
    var uScale = gl.getUniformLocation(program, 'u_scale');
    var uLift = gl.getUniformLocation(program, 'u_lift');
    var uSat = gl.getUniformLocation(program, 'u_saturation');

    // 4 palettes per theme — each: [color0, color1, color2]
    // Light: very pastel (scale compresses range, lift pushes toward white)
    var lightPresets = [
      { c: [[0.72,0.55,1.0], [0.45,0.65,1.0], [0.30,0.85,0.90]], scale: 0.33, lift: 0.65, sat: 0.65 },
      { c: [[1.0,0.60,0.70], [0.85,0.55,0.90], [1.0,0.75,0.60]], scale: 0.33, lift: 0.65, sat: 0.65 },
      { c: [[0.30,0.90,0.80], [0.45,0.90,0.55], [0.50,0.75,1.0]], scale: 0.33, lift: 0.65, sat: 0.65 },
      { c: [[1.0,0.85,0.40], [1.0,0.70,0.50], [0.95,0.60,0.65]], scale: 0.33, lift: 0.65, sat: 0.65 }
    ];
    // Dark: richer, more visible
    var darkPresets = [
      { c: [[0.55,0.30,0.85], [0.20,0.35,0.75], [0.15,0.55,0.65]], scale: 0.38, lift: 0.06, sat: 0.7 },
      { c: [[0.75,0.20,0.55], [0.55,0.25,0.75], [0.25,0.35,0.70]], scale: 0.38, lift: 0.06, sat: 0.7 },
      { c: [[0.15,0.65,0.55], [0.20,0.60,0.35], [0.20,0.45,0.70]], scale: 0.38, lift: 0.06, sat: 0.7 },
      { c: [[0.75,0.55,0.25], [0.70,0.40,0.20], [0.65,0.30,0.45]], scale: 0.38, lift: 0.06, sat: 0.7 }
    ];
    var presetCount = 4;
    var timeOffset = 25.0;

    // Inject a 2D canvas into each section
    var layers = [];
    sections.forEach(function(sec, idx) {
      var c = document.createElement('canvas');
      c.className = 'plasma-layer';
      c.setAttribute('aria-hidden', 'true');
      sec.appendChild(c);
      layers.push({ canvas: c, ctx: c.getContext('2d'), section: sec, visible: false, preset: idx % presetCount });
    });

    var dprCap = 1.5;
    function resize() {
      var dpr = Math.min(window.devicePixelRatio || 1, dprCap);
      var w = sections[0].offsetWidth;
      var h = sections[0].offsetHeight;
      offscreen.width = w * dpr;
      offscreen.height = h * dpr;
      gl.viewport(0, 0, offscreen.width, offscreen.height);
      gl.uniform2f(uRes, offscreen.width, offscreen.height);
      layers.forEach(function(l) {
        l.canvas.width = l.section.offsetWidth * dpr;
        l.canvas.height = l.section.offsetHeight * dpr;
      });
    }

    var resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(resize, 100);
    });

    resize();

    // Track which sections are visible
    var io = new IntersectionObserver(function(entries) {
      entries.forEach(function(e) {
        for (var i = 0; i < layers.length; i++) {
          if (layers[i].section === e.target) { layers[i].visible = e.isIntersecting; break; }
        }
      });
    }, { threshold: 0 });
    sections.forEach(function(s) { io.observe(s); });

    var raf;
    var paused = false;
    var startTime = performance.now();

    function render() {
      raf = requestAnimationFrame(render);
      var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      var presets = isDark ? darkPresets : lightPresets;
      var t = (performance.now() - startTime) / 1000;
      for (var i = 0; i < layers.length; i++) {
        if (!layers[i].visible) continue;
        var p = presets[layers[i].preset];
        gl.uniform1f(uTime, t + layers[i].preset * timeOffset);
        gl.uniform3fv(uColor0, p.c[0]);
        gl.uniform3fv(uColor1, p.c[1]);
        gl.uniform3fv(uColor2, p.c[2]);
        gl.uniform1f(uScale, p.scale);
        gl.uniform1f(uLift, p.lift);
        gl.uniform1f(uSat, p.sat);
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
        layers[i].ctx.drawImage(offscreen, 0, 0, offscreen.width, offscreen.height, 0, 0, layers[i].canvas.width, layers[i].canvas.height);
      }
    }

    document.addEventListener('visibilitychange', function() {
      if (document.hidden) { paused = true; cancelAnimationFrame(raf); }
      else if (paused) { paused = false; render(); }
    });

    motionQuery.addEventListener('change', function(e) {
      if (e.matches) {
        cancelAnimationFrame(raf);
        paused = true;
        document.body.classList.remove('plasma-active');
        layers.forEach(function(l) { l.canvas.style.display = 'none'; });
      } else {
        layers.forEach(function(l) { l.canvas.style.display = ''; });
        document.body.classList.add('plasma-active');
        paused = false;
        render();
      }
    });

    document.body.classList.add('plasma-active');
    render();
  })();
  </script>

  <script>
  // Topnav logo — show when hero scrolls away (or immediately on sub pages)
  (function() {
    var logo = document.getElementById('topnav-logo');
    var navCanvas = document.getElementById('topnav-mesh');
    var hero = document.querySelector('.hero');
    if (!logo) return;

    // Element always has full dimensions (hidden via scale+margin),
    // so init the mesh right away
    if (navCanvas) SwissCross.create(navCanvas, { cameraZ: 7, cubeSize: 0.9, fov: 35, arm: 1, thick: 0, opacity: 0.55, camX: -0.7 });

    if (!hero) {
      logo.classList.add('is-visible');
    } else {
      document.body.classList.add('hero-active');
      var io = new IntersectionObserver(function(entries) {
        var gone = entries[0].intersectionRatio < 0.5;
        logo.classList.toggle('is-visible', gone);
        document.body.classList.toggle('hero-active', !gone);
      }, { threshold: [0, 0.5, 1] });
      io.observe(hero);
    }
  })();

  // Footer mesh
  (function() {
    var canvas = document.getElementById('footer-mesh');
    if (!canvas) return;
    SwissCross.create(canvas, { cameraZ: 16, cubeSize: 0.88, fov: 35 });
  })();
  </script>

  <script>
  // Progress tracker — vertical dot nav
  (function() {
    var tracker = document.getElementById('progress-tracker');
    var main = document.getElementById('main');
    if (!tracker || !main) return;

    var sections = main.querySelectorAll(':scope > section, :scope > .hero');
    if (sections.length < 2) { tracker.style.display = 'none'; return; }

    // Build dots
    sections.forEach(function(sec, i) {
      var dot = document.createElement('button');
      dot.className = 'progress-tracker__dot';
      dot.setAttribute('aria-label', sec.getAttribute('aria-label') || ('Section ' + (i + 1)));
      dot.addEventListener('click', function() {
        sec.scrollIntoView({ behavior: 'smooth' });
      });
      tracker.appendChild(dot);
    });

    var dots = tracker.querySelectorAll('.progress-tracker__dot');

    // Track which section is most visible
    var visibleRatios = new Array(sections.length).fill(0);

    function updateActive() {
      var maxIdx = 0;
      var maxVal = 0;
      for (var i = 0; i < visibleRatios.length; i++) {
        if (visibleRatios[i] > maxVal) { maxVal = visibleRatios[i]; maxIdx = i; }
      }
      dots.forEach(function(d, i) {
        d.classList.toggle('is-active', i === maxIdx);
      });
    }

    var io = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        var idx = Array.prototype.indexOf.call(sections, entry.target);
        if (idx !== -1) visibleRatios[idx] = entry.intersectionRatio;
      });
      updateActive();
    }, { threshold: [0, 0.1, 0.2, 0.3, 0.5, 0.7, 1] });

    sections.forEach(function(sec) { io.observe(sec); });

    // Activate first dot initially
    if (dots.length) dots[0].classList.add('is-active');
  })();

  // Smooth scroll-snap — JS-based for cross-browser smooth animation
  (function() {
    var main = document.getElementById('main');
    if (!main) return;
    var sections = main.querySelectorAll(':scope > section, :scope > .hero, :scope > footer');
    if (sections.length < 2) return;

    var scrollTimer = null;
    var snapping = false;
    var gap = parseFloat(getComputedStyle(document.documentElement).fontSize) * 0.75 || 12;

    function getSnapTarget() {
      var viewH = window.innerHeight;
      var best = null;
      var bestDist = Infinity;
      sections.forEach(function(sec) {
        var r = sec.getBoundingClientRect();
        var dist = Math.abs(r.top - gap);
        if (dist < bestDist) {
          bestDist = dist;
          best = sec;
        }
      });
      if (bestDist < viewH * 0.4) return best;
      return null;
    }

    function onScrollEnd() {
      if (snapping) return;
      var target = getSnapTarget();
      if (!target) return;
      var r = target.getBoundingClientRect();
      var offset = r.top - gap;
      if (Math.abs(offset) < 2) return;
      snapping = true;
      window.scrollBy({ top: offset, behavior: 'smooth' });
      setTimeout(function() { snapping = false; }, 600);
    }

    window.addEventListener('scroll', function() {
      if (snapping) return;
      clearTimeout(scrollTimer);
      scrollTimer = setTimeout(onScrollEnd, 120);
    }, { passive: true });
  })();

  /* Hex address anchors — each page gets a unique base (0x00, 0x10, 0x20…) */
  (function() {
    var main = document.getElementById('main');
    if (!main) return;
    var pageKey = main.getAttribute('data-hex-page') || '_index';
    /* 0xPPSS — PP = page (0x00–0xFF), SS = section (0x00–0xFF) */
    var hexMap = {
      '_index': 0x00, 'vision': 0x01, 'programm': 0x02, 'mitmachen': 0x03,
      'manifest': 0x10, 'kein-links-rechts': 0x11,
      'digitale-souveraenitaet': 0x20, 'robotik': 0x21,
      'uebergaenge': 0x22, 'life-science': 0x23,
      'grundeinkommen': 0x24, 'stadte-wohnen': 0x25,
      'research-innovation': 0x26, 'energy-resilience': 0x27,
      'offener-staat': 0x28, 'neutralitaet-frieden': 0x29,
      'talent-integration': 0x2A, 'sprache-verstaendigung': 0x2B,
      'zukunftslabor/_index': 0x30, 'zukunftslabor/notizen/_index': 0x31, 'zukunftslabor/methodik': 0x32,
      'menschen': 0x40, 'kontakt': 0x41,
      'impressum': 0xF0, 'datenschutz': 0xF1,
      'info': 0xF2, 'aktuelles/_index': 0xF3
    };
    var page = hexMap[pageKey] != null ? hexMap[pageKey] : 0x00;
    var sections = main.querySelectorAll(':scope > section, :scope > .hero');
    sections.forEach(function(sec, i) {
      var addr = (page << 8) | i;
      var hex = '0x' + addr.toString(16).toUpperCase().padStart(4, '0');
      sec.id = sec.id || hex;
      var a = document.createElement('a');
      a.className = 'hex-anchor';
      a.href = '#' + sec.id;
      a.textContent = hex;
      a.setAttribute('aria-hidden', 'true');
      a.addEventListener('click', function(e) {
        e.preventDefault();
        openShareOverlay(sec, hex, a);
      });
      sec.appendChild(a);
    });

    /* Share overlay logic */
    var shareOverlay = document.getElementById('share-overlay');
    var backdrop = document.getElementById('overlay-backdrop');
    var shareClose = document.getElementById('share-close');
    var shareHex = document.getElementById('share-hex');
    var shareBreadcrumb = document.getElementById('share-breadcrumb');
    var shareTitle = document.getElementById('share-title');
    var shareUrl = document.getElementById('share-url');
    var shareCopy = document.getElementById('share-copy');
    var shareX = document.getElementById('share-x');
    var shareLI = document.getElementById('share-linkedin');
    var shareWA = document.getElementById('share-whatsapp');
    var shareTG = document.getElementById('share-telegram');
    var shareEmail = document.getElementById('share-email');
    var triggerAnchor = null;

    var brandName = '{% if lang == "fr" %}Le Futur{% elif lang == "it" %}Il Futuro{% elif lang == "en" %}The Future{% else %}Die Zukunft{% endif %}';

    function openShareOverlay(sec, hex, anchor) {
      /* Close command overlay if open */
      var cmdOverlay = document.getElementById('command-overlay');
      if (cmdOverlay && cmdOverlay.classList.contains('is-open')) {
        cmdOverlay.classList.remove('is-open');
        backdrop.classList.remove('is-open');
        cmdOverlay.setAttribute('aria-hidden', 'true');
        var topnav = document.querySelector('.topnav');
        if (topnav) topnav.style.display = '';
        var sparkleBtns = document.querySelectorAll('.sparkle-btn');
        sparkleBtns.forEach(function(b) { b.classList.remove('is-open'); b.setAttribute('aria-expanded', 'false'); });
      }

      triggerAnchor = anchor;

      /* Extract section heading */
      var heading = sec.querySelector('h2, h3');
      var headingText = heading ? heading.textContent.trim() : '';
      var pageTitle = document.title.split(' — ')[0] || document.title;
      var url = window.location.origin + window.location.pathname + '#' + sec.id;

      /* Populate overlay */
      shareHex.textContent = hex;
      shareBreadcrumb.textContent = brandName + ' > ' + pageTitle;
      shareTitle.textContent = headingText || pageTitle;
      shareUrl.value = url;

      /* Build share URLs */
      var encodedUrl = encodeURIComponent(url);
      var encodedTitle = encodeURIComponent(headingText || pageTitle);
      shareX.href = 'https://x.com/intent/tweet?url=' + encodedUrl + '&text=' + encodedTitle;
      shareLI.href = 'https://www.linkedin.com/sharing/share-offsite/?url=' + encodedUrl;
      shareWA.href = 'https://wa.me/?text=' + encodedTitle + '%20' + encodedUrl;
      shareTG.href = 'https://t.me/share/url?url=' + encodedUrl + '&text=' + encodedTitle;
      shareEmail.href = 'mailto:?subject=' + encodedTitle + '&body=' + encodedUrl;

      /* Show overlay + backdrop */
      shareOverlay.classList.add('is-open');
      shareOverlay.setAttribute('aria-hidden', 'false');
      backdrop.classList.add('is-open');

      setTimeout(function() { shareCopy.focus(); }, 150);
    }

    function closeShareOverlay() {
      shareOverlay.classList.remove('is-open');
      shareOverlay.setAttribute('aria-hidden', 'true');
      backdrop.classList.remove('is-open');
      if (triggerAnchor) { triggerAnchor.focus(); triggerAnchor = null; }
    }

    shareClose.addEventListener('click', closeShareOverlay);

    /* Copy button */
    shareCopy.addEventListener('click', function() {
      navigator.clipboard.writeText(shareUrl.value).then(function() {
        shareCopy.textContent = 'Copied!';
        shareCopy.classList.add('is-copied');
        setTimeout(function() {
          shareCopy.textContent = 'Copy';
          shareCopy.classList.remove('is-copied');
        }, 2000);
      });
    });

    /* Close on backdrop click (only if share overlay is open) */
    backdrop.addEventListener('click', function() {
      if (shareOverlay.classList.contains('is-open')) {
        closeShareOverlay();
      }
    });

    /* Escape + focus trap */
    document.addEventListener('keydown', function(e) {
      if (!shareOverlay.classList.contains('is-open')) return;
      if (e.key === 'Escape') {
        closeShareOverlay();
        return;
      }
      if (e.key === 'Tab') {
        var focusable = shareOverlay.querySelectorAll('a[href], button, input');
        if (!focusable.length) return;
        var first = focusable[0];
        var last = focusable[focusable.length - 1];
        if (e.shiftKey) {
          if (document.activeElement === first) { e.preventDefault(); last.focus(); }
        } else {
          if (document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      }
    });
  })();

  // Scroll-to-top button
  (function() {
    var btn = document.getElementById('to-top');
    var main = document.getElementById('main');
    if (!btn || !main) return;

    var first = main.querySelector(':scope > section, :scope > .hero');
    if (!first) return;

    var io = new IntersectionObserver(function(entries) {
      btn.classList.toggle('is-visible', !entries[0].isIntersecting);
    }, { threshold: 0 });
    io.observe(first);

    btn.addEventListener('click', function() {
      first.scrollIntoView({ behavior: 'smooth' });
    });
  })();
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
  }
  </script>
  {% block body_end %}{% endblock body_end %}
</body>
</html>
