{% extends "base.html" %}
{% import "macros/pillar_cards.html" as cards %}

{% block title %}{{ section.title | default(value=section.extra.hero_title | default(value=config.title)) }}{% endblock %}

{% block head_extra %}{% endblock %}

{% block content %}

{# ===== Hero — brandmark ===== #}
<section class="hero" id="hero" aria-label="Hero">
  <canvas class="hero__mesh" id="hero-mesh" aria-hidden="true"></canvas>
  <div class="hero__display">
    <h1 class="hero__big">
      {% if lang == "fr" %}Le Futur.{% elif lang == "it" %}Il Futuro.{% elif lang == "en" %}The Future.{% else %}Die Zukunft.{% endif %}
    </h1>
    {% if section.extra.hero_subline %}
    <p class="hero__subline" id="hero-subline">{{ section.extra.hero_subline }}</p>
    {% endif %}
  </div>
</section>

{# ===== Subtitle / positioning ===== #}
<section class="canvas canvas--hex" aria-label="Subtitle">
  <div class="container container--narrow" style="text-align: center;">
    <h2>{{ section.extra.hero_subtitle | default(value="") }}</h2>
  </div>
</section>

{# ===== What's changing — title ===== #}
{% if section.extra.changes %}
<section class="canvas canvas--hex" aria-label="{{ section.extra.changes_title | default(value='What is changing') }}">
  <div class="container container--narrow" style="text-align: center;">
    <h2>{{ section.extra.changes_title | default(value="") }}</h2>
  </div>
</section>

{# ===== What's changing — cards ===== #}
<section class="canvas canvas--hex" aria-label="{{ section.extra.changes_title | default(value='What is changing') }}">
  <div class="container">
    <div class="bento-grid">
      {% for item in section.extra.changes %}
      <div class="glass-card reveal-up reveal-delay-{{ loop.index }}">
        {% if item.icon %}<p class="glass-card__icon">{{ item.icon }}</p>{% endif %}
        <h3 class="glass-card__title">{{ item.title }}</h3>
        <p class="glass-card__text">{{ item.text }}</p>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

{# ===== What we propose — title + carousel ===== #}
{% if section.extra.pillars %}
<section class="canvas canvas--hex" aria-label="{{ section.extra.pillars_title | default(value='Pillars') }}">
  <div class="container container--narrow" style="text-align: center;">
    <h2>{{ section.extra.pillars_title | default(value="") }}</h2>
  </div>
</section>

<section class="canvas canvas--carousel" aria-label="{{ section.extra.pillars_title | default(value='Pillars') }}" aria-roledescription="carousel">
  <div class="carousel" id="pillar-carousel">
    <div class="carousel__track" aria-live="off" id="carousel-track">
      {# Duplicate cards for seamless loop #}
      {% for item in section.extra.pillars %}
      <div class="glass-card carousel__card" role="group" aria-roledescription="slide" aria-label="{{ item.title }}">
        {% if item.icon %}<p class="glass-card__icon">{{ item.icon }}</p>{% endif %}
        <h3 class="glass-card__title">{{ item.title }}</h3>
        <p class="glass-card__text">{{ item.text }}</p>
        {% if item.link %}<a class="btn btn--sm" href="{{ get_url(path=item.link, lang=lang) }}">{{ trans(key="cta_learn_more", lang=lang) }}</a>{% endif %}
      </div>
      {% endfor %}
      {% for item in section.extra.pillars %}
      <div class="glass-card carousel__card" aria-hidden="true">
        {% if item.icon %}<p class="glass-card__icon">{{ item.icon }}</p>{% endif %}
        <h3 class="glass-card__title">{{ item.title }}</h3>
        <p class="glass-card__text">{{ item.text }}</p>
        {% if item.link %}<a class="btn btn--sm" href="{{ get_url(path=item.link, lang=lang) }}" tabindex="-1">{{ trans(key="cta_learn_more", lang=lang) }}</a>{% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

{# ===== How we start (timeline) ===== #}
{% if section.extra.timeline %}
<section class="canvas canvas--hex" aria-label="{{ section.extra.timeline_title | default(value='Timeline') }}">
  <div class="container" style="display: flex; flex-direction: column; align-items: center;">
    <h2 style="text-align: center; margin-bottom: 2rem;">{{ section.extra.timeline_title | default(value="") }}</h2>
    <div class="timeline">
      {% for step in section.extra.timeline %}
      <div class="timeline__item reveal-up reveal-delay-{{ loop.index }}">
        <div class="timeline__marker">{{ loop.index }}</div>
        <div class="timeline__content">
          <p class="timeline__phase">{{ step.phase }}</p>
          <p class="timeline__title">{{ step.title }}</p>
          <p class="timeline__text">{{ step.text }}</p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

{# ===== CTA — get involved ===== #}
{% if section.extra.cta_title %}
<section class="canvas cta-section" aria-label="{{ section.extra.cta_title }}">
  <div class="container container--narrow" style="text-align: center;">
    <h2>{{ section.extra.cta_title }}</h2>
    {% if section.extra.cta_text %}
    <p class="cta-section__text">{{ section.extra.cta_text }}</p>
    {% endif %}
    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
      <a class="btn btn--glow" href="{{ get_url(path='@/mitmachen.md', lang=lang) }}">{{ trans(key="cta_join", lang=lang) }}</a>
      <a class="btn btn--outline" href="{{ get_url(path='@/programm.md', lang=lang) }}">{{ trans(key="cta_program", lang=lang) }}</a>
    </div>
  </div>
</section>
{% endif %}

<script>
(function() {
  var canvas = document.getElementById('hero-mesh');
  if (!canvas) return;
  function init() {
    if (typeof SwissCross !== 'undefined') {
      SwissCross.create(canvas, { cameraZ: 22, cubeSize: 0.88, fov: 35 });
    } else {
      setTimeout(init, 50);
    }
  }
  if (typeof THREE !== 'undefined') { init(); }
  else {
    var s = document.querySelector('script[src*="three"]');
    if (s) s.addEventListener('load', init);
  }
})();

// Hero subline — reveal on first scroll-down, lock scroll during animation
(function() {
  var subline = document.getElementById('hero-subline');
  var hero = document.getElementById('hero');
  if (!subline || !hero) return;
  var done = false;
  var root = document.documentElement;

  function heroInView() {
    var r = hero.getBoundingClientRect();
    return r.top > -r.height * 0.5 && r.top < window.innerHeight * 0.5;
  }

  function lock() {
    root.style.overflow = 'hidden';
    root.style.scrollSnapType = 'none';
  }

  function unlock() {
    root.style.overflow = '';
    root.style.scrollSnapType = '';
  }

  function reveal() {
    if (done) return;
    done = true;
    lock();
    subline.classList.add('is-visible');
    setTimeout(function() {
      unlock();
      cleanup();
    }, 800);
  }

  function cleanup() {
    window.removeEventListener('wheel', onWheel);
    window.removeEventListener('touchstart', onTouchStart);
    window.removeEventListener('touchmove', onTouchMove);
    window.removeEventListener('keydown', onKeyDown);
  }

  var touchY = null;

  function onWheel(e) {
    if (done && root.style.overflow === 'hidden') return;
    if (!done && e.deltaY > 0 && heroInView()) {
      e.preventDefault();
      reveal();
    }
  }
  function onTouchStart(e) {
    touchY = e.touches[0].clientY;
  }
  function onTouchMove(e) {
    if (touchY === null) return;
    var dy = touchY - e.changedTouches[0].clientY;
    touchY = null;
    if (!done && dy > 10 && heroInView()) {
      e.preventDefault();
      reveal();
    }
  }
  function onKeyDown(e) {
    if (done) return;
    var keys = ['ArrowDown', 'PageDown', ' '];
    if (keys.indexOf(e.key) !== -1 && heroInView()) {
      e.preventDefault();
      reveal();
    }
  }

  window.addEventListener('wheel', onWheel, { passive: false });
  window.addEventListener('touchstart', onTouchStart, { passive: true });
  window.addEventListener('touchmove', onTouchMove, { passive: false });
  window.addEventListener('keydown', onKeyDown);
})();

// Reveal-on-scroll
(function() {
  var els = document.querySelectorAll('.reveal-up');
  if (!els.length) return;
  var io = new IntersectionObserver(function(entries) {
    entries.forEach(function(e) {
      if (e.isIntersecting) {
        e.target.classList.add('is-visible');
        io.unobserve(e.target);
      }
    });
  }, { threshold: 0.15 });
  els.forEach(function(el) { io.observe(el); });
})();

// Pillar carousel — continuous slow scroll, swipeable by touch/mouse drag
(function() {
  var track = document.querySelector('.carousel__track');
  if (!track) return;
  var cards = track.children;
  var half = cards.length / 2;
  var totalWidth = 0;
  for (var i = 0; i < half; i++) {
    totalWidth += cards[i].offsetWidth;
  }
  var gap = parseFloat(getComputedStyle(track).gap) || 24;
  totalWidth += gap * half;

  var pos = 0;
  var speed = 0.5;
  var raf;
  var dragging = false;
  var hoverPaused = false;
  var offscreen = false;

  // Drag/swipe state
  var dragStartX = 0;
  var dragStartY = 0;
  var dragStartPos = 0;
  var dragLocked = false;   // true once we know it's a horizontal swipe
  var dragRejected = false; // true once we know it's a vertical scroll
  var lastX = 0;
  var lastTime = 0;
  var velocity = 0;

  function isRunning() { return !dragging && !hoverPaused && !offscreen; }

  function wrapPos() { while (pos > 0) pos -= totalWidth; while (pos < -totalWidth) pos += totalWidth; }

  function animate() {
    raf = requestAnimationFrame(animate);
    if (!dragging) {
      if (Math.abs(velocity) > 0.3) {
        pos += velocity;
        velocity *= 0.95;
        wrapPos();
      } else {
        velocity = 0;
        pos -= speed;
        wrapPos();
      }
    }
    track.style.transform = 'translateX(' + pos + 'px)';
  }

  function start() { if (!raf) animate(); }
  function stop() { cancelAnimationFrame(raf); raf = null; }

  function sync() { isRunning() ? start() : stop(); }

  // Pointer helpers (unified touch + mouse)
  function getX(e) { return e.touches ? e.touches[0].clientX : e.clientX; }
  function getY(e) { return e.touches ? e.touches[0].clientY : e.clientY; }

  function onDragStart(e) {
    dragging = true;
    dragLocked = false;
    dragRejected = false;
    dragStartX = getX(e);
    dragStartY = getY(e);
    dragStartPos = pos;
    lastX = dragStartX;
    lastTime = Date.now();
    velocity = 0;
    track.style.cursor = 'grabbing';
    sync();
  }

  function onDragMove(e) {
    if (!dragging || dragRejected) return;
    var cx = getX(e);
    var cy = getY(e);
    var dx = cx - dragStartX;
    var dy = cy - dragStartY;

    if (!dragLocked) {
      if (Math.abs(dx) < 8 && Math.abs(dy) < 8) return;
      if (Math.abs(dy) > Math.abs(dx)) {
        dragRejected = true;
        dragging = false;
        track.style.cursor = '';
        sync();
        return;
      }
      dragLocked = true;
    }

    if (e.cancelable) e.preventDefault();
    var now = Date.now();
    var dt = now - lastTime;
    if (dt > 0) velocity = (cx - lastX) / dt * 16;
    lastX = cx;
    lastTime = now;
    pos = dragStartPos + dx;
    wrapPos();
    track.style.transform = 'translateX(' + pos + 'px)';
  }

  function onDragEnd() {
    if (!dragging && !dragLocked) return;
    dragging = false;
    dragLocked = false;
    track.style.cursor = '';
    sync();
  }

  // Touch events
  track.addEventListener('touchstart', function(e) { onDragStart(e); }, { passive: true });
  track.addEventListener('touchmove', function(e) { onDragMove(e); }, { passive: false });
  track.addEventListener('touchend', onDragEnd);
  track.addEventListener('touchcancel', onDragEnd);

  // Mouse drag
  track.addEventListener('mousedown', function(e) { e.preventDefault(); onDragStart(e); });
  document.addEventListener('mousemove', function(e) { if (dragging) onDragMove(e); });
  document.addEventListener('mouseup', onDragEnd);

  // Pause on hover (non-drag)
  track.addEventListener('mouseenter', function() { if (!dragging) { hoverPaused = true; sync(); } });
  track.addEventListener('mouseleave', function() { hoverPaused = false; sync(); });

  // Pause when not visible
  var section = track.closest('.canvas--carousel');
  if (section) {
    var io = new IntersectionObserver(function(entries) {
      offscreen = !entries[0].isIntersecting;
      sync();
    }, { threshold: 0 });
    io.observe(section);
  } else {
    sync();
  }
})();
</script>

{% endblock %}
